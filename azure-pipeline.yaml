pool:
  vmImage: ubuntu-latest

container: 
  image: golang:1.18.1-buster
  endpoint: DockerHub - Han_Yang_Kuo

variables:
  GOPATH: '$(Pipeline.Workspace)' # Go workspace path
  GOBIN:  '$(GOPATH)/bin' # Go binaries path
  # GOROOT: '/usr/local/go1.11' # Go installation path

steps:
  - checkout: self
    path: src/botnet
  - script: |
      echo pwd = $(pwd)
      echo PATH = $(PATH)
      echo "** echo GOBIN **"
      echo GOBIN = $(GOBIN)
      echo "** echo GOPATH **"
      echo GOPATH = $(GOPATH)
      go mod tidy
      go env -w GOOS=windows
      go env -w GOARCH=amd64
      go install mvdan.cc/garble@latest
      
      echo PATH = $PATH
      echo "** echo /go/bin **"
      ls $(GOBIN)

      garble build -o agent.exe com.young/botnet/agent
      
  - task: CopyFiles@2
    inputs:
      Contents: |
        *.exe
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
  - task: PublishBuildArtifacts@1
    inputs:
      artifactName: agent
  

